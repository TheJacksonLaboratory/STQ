bootstrap: shub
from: jaxreg.jax.org/singlecell/python:3.8

%post
apt-get update
apt-get install -y gcc
apt-get install -y git
apt-get install -y g++
apt-get install -y openslide-tools
apt-get install -y python-openslide
apt-get install -y libsm6 libxext6
apt-get install -y libxrender-dev
apt-get install -y procps

/opt/conda/bin/conda install --quiet -y python=3.6.12 pip=20.3.1
/opt/conda/bin/conda install --quiet -y -c conda-forge pandas tifftools
/opt/conda/bin/pip install gdown openslide-python==1.1.2 docopt==0.6.2 future==0.18.2 imgaug==0.4.0 matplotlib==3.3.0 numpy==1.19.1 opencv-python==4.3.0.36 pandas==1.1.0 pillow==7.2.0 psutil==5.7.3 scikit-image==0.17.2 scikit-learn==0.23.1 scipy==1.5.2 tensorboard==2.3.0 tensorboardx==2.1 termcolor==1.1.0 tqdm==4.48.0 torch==1.6.0 torchvision==0.7.0

/opt/conda/bin/gdown 1SbSArI3KOOWHxRlxnjchO7_MbWzB4lNR

git clone https://github.com/vqdang/hover_net.git
cd /hover_net/
git reset --hard 842964dc5d26ffe196d236d16fad16643a103850

f=/hover_net/misc/wsi_handler.py
sed -i '119 i \ \ \ \ \ \ \ \ wsi_properties = {'openslide.PROPERTY_NAME_OBJECTIVE_POWER': "0", 'openslide.PROPERTY_NAME_MPP_X': "0", 'openslide.PROPERTY_NAME_MPP_Y': "0", 'openslide.PROPERTY_NAME_VENDOR': "generic-tiff"}' $f
sed -i '120 i \ \ \ \ \ \ \ \ for key in wsi_properties.keys():' $f
sed -i '121 i \ \ \ \ \ \ \ \ \ \ \ \ try:' $f
sed -i '122 i \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ wsi_properties.update({key: self.file_ptr.properties[key]})' $f
sed -i '123 i \ \ \ \ \ \ \ \ \ \ \ \ except Exception as exception:' $f
sed -i '124 i \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ print("wsi_properties:", exception)' $f
sed -i '125 i \ \ \ \ \ \ \ \ try:' $f
sed -i '126 i \ \ \ \ \ \ \ \ \ \ \ \ wsi_properties.update({openslide.PROPERTY_NAME_OBJECTIVE_POWER: float(self.file_ptr.properties["tiff.DocumentName"])})' $f
sed -i '127 i \ \ \ \ \ \ \ \ except:' $f
sed -i '128 i \ \ \ \ \ \ \ \ \ \ \ \ pass' $f
sed -i '129 i \ \ \ \ \ \ \ \ try:' $f
sed -i '130 i \ \ \ \ \ \ \ \ \ \ \ \ wsi_properties.update({openslide.PROPERTY_NAME_MPP_X: float(self.file_ptr.properties["tiff.Make"])})' $f
sed -i '131 i \ \ \ \ \ \ \ \ except:' $f
sed -i '132 i \ \ \ \ \ \ \ \ \ \ \ \ pass' $f
sed -i '133 i \ \ \ \ \ \ \ \ try:' $f
sed -i '134 i \ \ \ \ \ \ \ \ \ \ \ \ wsi_properties.update({openslide.PROPERTY_NAME_MPP_Y: float(self.file_ptr.properties["tiff.Model"])})' $f
sed -i '135 i \ \ \ \ \ \ \ \ except:' $f
sed -i '136 i \ \ \ \ \ \ \ \ \ \ \ \ pass' $f
sed -i '137 i \ \ \ \ \ \ \ \ try:' $f
sed -i '138 i \ \ \ \ \ \ \ \ \ \ \ \ wsi_properties.update({openslide.PROPERTY_NAME_VENDOR: self.file_ptr.properties["tiff.Software"]})' $f
sed -i '139 i \ \ \ \ \ \ \ \ except:' $f
sed -i '140 i \ \ \ \ \ \ \ \ \ \ \ \ pass' $f

sed -i '188 i \ \ \ \ exit(0)' /hover_net/run_infer.py
